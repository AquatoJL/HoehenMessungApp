# =============================================================================
# main.kv
# Beschreibung: GUI-Definition für den CameraScreen.
# Zweck: Echtzeit-Kameraansicht mit Neigungssensor-Overlay und Messparameter-
#        Panel zur trigonometrischen Entfernungs- und Höhenberechnung.
# Layout: Horizontal geteilt – 75% Kamerabereich | 25% Seitenmenü
# =============================================================================

# -----------------------------------------------------------------------------
# Crosshair
# Fadenkreuz-Widget, das zentriert über dem Kamerabild eingeblendet wird.
# Dient zur visuellen Ausrichtung auf das Messobjekt.
# Besteht aus einer weißen Linie (2px) mit schwarzer Outline (1px) für
# maximalen Kontrast auf hellem und dunklem Hintergrund.
# -----------------------------------------------------------------------------
<Crosshair@MDWidget>:
    disabled: True
    size_hint: None, None
    size: dp(60), dp(60)
    pos_hint: {"center_x": 0.5, "center_y": 0.5}

    canvas:
        Color:
            rgba: 1,1,1,1
        Line:
            width: 2
            points: root.center_x - root.width / 2, root.center_y, root.center_x + root.width / 2, root.center_y
        Line:
            width: 2
            points: root.center_x, root.center_y - root.height / 2, root.center_x, root.center_y + root.height / 2

        Color:
            rgba: 0,0,0,1
        Line:
            width: 1
            points: root.center_x - root.width / 2, root.center_y, root.center_x + root.width / 2, root.center_y
        Line:
            width: 1
            points: root.center_x, root.center_y - root.height / 2, root.center_x, root.center_y + root.height / 2

# -----------------------------------------------------------------------------
# OwnIcon
# Wiederverwendbares Icon-Widget (weiß, zentriert).
# Basiert auf MDIcon mit fester Custom-Farbe für einheitliches Erscheinungsbild.
# -----------------------------------------------------------------------------
<OwnIcon@MDIcon>:
    theme_icon_color: "Custom"
    color: 1, 1, 1, 1
    valign: "middle"
    halign: "center"
    text_size: self.size
    pos_hint: {"center_x": 1, "center_y": 0.5}

# -----------------------------------------------------------------------------
# OwnLabel
# Standardbeschriftung (weiß, zentriert).
# Wird für alle Bezeichnungen und Anzeigewerte im UI verwendet.
# -----------------------------------------------------------------------------
<OwnLabel@MDLabel>
    theme_text_color: "Custom"
    text_color: 1, 1, 1, 1
    halign: "center"
    valign: "middle"

# -----------------------------------------------------------------------------
# MeasureLabel
# Großes Anzeigelabel für Messwerte wie Neigungswinkel.
# Hebt numerische Messergebnisse visuell hervor.
# -----------------------------------------------------------------------------
<MeasureLabel@MDLabel>
    font_size: '40sp'
    theme_text_color: "Custom"
    text_color: 1, 1, 1, 1
    halign: "center"
    valign: "middle"

# -----------------------------------------------------------------------------
# OwnBox
# Horizontale Zeilenbox mit fester Höhe.
# Dient als Basis-Container für einzeilige Parameter-Zeilen im Seitenmenü.
# -----------------------------------------------------------------------------
<OwnBox@MDBoxLayout>
    orientation: 'horizontal'
    size_hint_y: 1
    spacing: dp(8)
    padding: [dp(8), 0]
    valign: "middle"

# =============================================================================
# CameraScreen
# Hauptscreen der Anwendung. Horizontal aufgeteilt in:
#   - Linker Bereich (75%): Kamera-Preview mit Overlay-Elementen
#   - Rechter Bereich (25%): Eingabe- und Anzeigepanel für Messparameter
# =============================================================================

<CameraScreen>:
    orientation: 'horizontal'
    
    # -------------------------------------------------------------------------
    # Linker Bereich: Kamera-Preview mit Overlays (75% Breite)
    # Enthält übereinander geschichtete Elemente via FloatLayout:
    #   1. Preview      – Live-Kamerabild (Hintergrund)
    #   2. Crosshair    – Fadenkreuz zur Zielanvisierung
    #   3. GridLayout   – Sensor-Informationspanel (Neigung & Wasserwaage)
    # -------------------------------------------------------------------------
    MDFloatLayout:
        size_hint_x: 0.75
        
        # Live-Kamerabild; letterbox_color füllt Randbereiche schwarz
        Preview:
            id: preview
            letterbox_color: 0, 0, 0, 1
        
        # Fadenkreuz-Overlay, zentriert im Kamerabild
        Crosshair:
        
        # -----------------------------------------------------------------
        # Sensor-Panel (2×2 Grid, unten-mittig positioniert)
        # Zeile 1: Beschriftungen  "Neigung" | "Wasserwaage"
        # Zeile 2: Messwerte       Neigungswinkel (numerisch) | Wasserwaage (grafisch)
        # Hintergrund: halbtransparentes, abgerundetes Rechteck
        # -----------------------------------------------------------------
        GridLayout:
            cols: 2
            rows: 2
            size_hint: None, None
            height: dp(90)
            width: dp(250)
            spacing: dp(24)
            pos_hint: {"center_x": 0.5, "center_y": 0.2}
            row_force_default: True
            row_default_height: dp(24)

            canvas.before:
                Color:
                    rgba: 0.4, 0.4, 0.4, 0.3
                RoundedRectangle:
                    pos: self.pos[0], self.pos[1] + dp(5)
                    size: self.size[0] + dp(15), self.size[1] 
                    radius: [12]

            # Spalten-Beschriftungen
            OwnLabel:
                text: "Neigung"

            OwnLabel:
                text: "Wasserwaage"

            # Numerischer Neigungswinkel (1 Dezimalstelle)
            MeasureLabel:
                text: str(round(root.tilt_angle, 1))

            # -----------------------------------------------------------------
            # Grafische (Wasserwaage)
            # Grüner Hintergrundbalken mit zwei schwarzen Begrenzungslinien
            # (Toleranzbereich). Ein grüner Kreis (Blase) bewegt sich
            # proportional zum roll_angle horizontal – zeigt Querneigung an.
            # -----------------------------------------------------------------
            MeasureLabel:
                canvas.before:
                    # Grüner Hintergrund
                    Color:
                        rgba: 0, 0.5, 0, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                    
                    Color:
                        rgba: 0, 0, 0, 1
                    # Linke Toleranzlinie
                    Line:
                        width: 1
                        points: [self.center_x-dp(20), self.y, self.center_x-dp(20), self.top]
                    # Rechte Toleranzlinie
                    Line:
                        width: 1
                        points: [self.center_x+dp(20), self.y, self.center_x+dp(20), self.top]
                
                # Bewegliche Blase: Position abhängig von root.roll_angle
                canvas:
                    Color:
                        rgba: 0.3, 1, 0.3, 0.7
                    Ellipse:
                        pos: self.center_x + -root.roll_angle * dp(0.57) - dp(8), self.center_y - dp(8)
                        size: dp(16), dp(16)
    
    # =========================================================================
    # Rechter Bereich: Messparameter-Panel (25% Breite)
    # Dunkles vertikales Layout mit Eingabe- und Anzeigezeilen für:
    #   - Telefonhöhe (editierbar)
    #   - Entfernung  (berechnet, nur Anzeige)
    #   - Höhe        (berechnet, nur Anzeige)
    # Abschluss: Mess-Button zum Starten der Berechnung
    # =========================================================================
    MDBoxLayout:
        orientation: 'vertical'
        size_hint_x: 0.25
        padding: dp(10)
        spacing: dp(10)
        
        canvas.before:
            Color:
                rgba: 0.2, 0.2, 0.2, 1
            Rectangle:
                pos: self.pos
                size: self.size

        # Oberer Abstandhalter
        Widget:

        # --- Telefonhöhe (Anzeige, nur lesbar) -------------------------------------------
        # Beschriftungszeile
        OwnBox:
            canvas.before:
                Color:
                    rgba: 0.4, 0.4, 0.4, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]

            OwnLabel:
                text: "Telefonhöhe"

        # Eingabezeile: Icon | TextInput | Einheit "m"
        # on_text_validate überträgt den eingegebenen Wert in root.phone_height
        OwnBox:
            canvas.before:
                Color:
                    rgba: 0.3, 0.3, 0.3, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]
            
            Widget:
                size_hint_x: 0.05

            OwnIcon:
                icon: "arrow-up-down"
            
            TextInput:
                id: phone_height_input
                text: str(root.phone_height)
                input_filter: 'float'
                font_size: '16sp'
                multiline: False
                on_text_validate: root.phone_height = round(float(self.text),1)
                foreground_color: 1, 1, 1, 1
                background_color: 0.4, 0.4, 0.4, 1
                halign: "center"
                padding_y: dp(5), 0

            
            OwnLabel:
                text: "m"
                size_hint_x: 0.3

        # --- Entfernung-Label (Anzeige, nur lesbar) ----------------------------
        OwnBox:
            canvas.before:
                Color:
                    rgba: 0.4, 0.4, 0.4, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]
            
            OwnLabel:
                text: "Entfernung"

        # --- Entfernung-Werte (Anzeige, nur lesbar) ----------------------------
        OwnBox:
            canvas.before:
                Color:
                    rgba: root.distance_background_color
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]
            
            Widget:
                size_hint_x: 0.05

            OwnIcon:
                icon: "arrow-expand-horizontal"
            
            OwnLabel:
                text: root.distance

        # --- Höhe-Label (Anzeige, nur lesbar) ---------------------------------
        OwnBox:
            canvas.before:
                Color:
                    rgba: 0.4, 0.4, 0.4, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]
            
            OwnLabel:
                text: "Höhe"

        # --- Höhe-Werte (Anzeige, nur lesbar) --------------------------------------
        OwnBox:
            canvas.before:
                Color:
                    rgba: root.height_background_color
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]
            
            Widget:
                size_hint_x: 0.05
            
            OwnIcon:
                icon: "arrow-expand-vertical"
            
            OwnLabel:
                text: root.object_height

        # --- Mess-Button -----------------------------------------------------
        # Startet die Messung via app.measure().
        # Text und Icon werden dynamisch über root-Properties gesteruert.
        MDFillRoundFlatIconButton:
            text: root.button_text
            icon: root.icon
            size_hint_x: 1
            size_hint_y: 1
            font_size: '16sp'
            md_bg_color: 0.7, 0, 0, 1
            on_press: root.toggle_mode()

        # Unterer Abstandhalter
        Widget:
